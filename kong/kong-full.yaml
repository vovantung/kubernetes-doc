# Namespace backend (nếu chưa có)
apiVersion v1
kind Namespace
metadata
  name backend
---
# Service Account for Kong Ingress Controller
apiVersion v1
kind ServiceAccount
metadata
  name kong-ingress-controller
  namespace kong
---
# RBAC Cluster Role
apiVersion rbac.authorization.k8s.iov1
kind ClusterRole
metadata
  name kong-ingress-controller
rules
  - apiGroups []
    resources [services, endpoints, pods, nodes, secrets, events, configmaps]
    verbs [get, list, watch, create]
  - apiGroups [apps]
    resources [deployments]
    verbs [get, list, watch]
  - apiGroups [networking.k8s.io]
    resources [ingresses, ingressclasses]
    verbs [get, list, watch]
  - apiGroups [configuration.konghq.com]
    resources
      - kongplugins
      - kongclusterplugins
      - kongcredentials
      - kongconsumers
      - kongingresses
      - kongconsumergroups
    verbs [get, list, watch]
  - apiGroups [discovery.k8s.io]
    resources [endpointslices]
    verbs [get, list, watch]
  - apiGroups [apiextensions.k8s.io]
    resources [customresourcedefinitions]
    verbs [get, list, watch]
  - apiGroups [coordination.k8s.io]
    resources [leases]
    verbs [get, list, watch, create, update]
---
# Cluster Role Binding
apiVersion rbac.authorization.k8s.iov1
kind ClusterRoleBinding
metadata
  name kong-ingress-controller
roleRef
  apiGroup rbac.authorization.k8s.io
  kind ClusterRole
  name kong-ingress-controller
subjects
  - kind ServiceAccount
    name kong-ingress-controller
    namespace kong
---
# Deployment của Kong Ingress Controller (watch namespace backend)
apiVersion appsv1
kind Deployment
metadata
  name kong-ingress-controller
  namespace kong
spec
  replicas 1
  selector
    matchLabels
      app kong-ingress-controller
  template
    metadata
      labels
        app kong-ingress-controller
    spec
      serviceAccountName kong-ingress-controller
      containers
        - name controller
          image kongkubernetes-ingress-controller3.5
          args
            - --kong-admin-url=httpkong-kong-admin.kong.svc.cluster.local8001
            - --ingress-class=kong
            - --watch-namespace=backend
---
# Secret kiểu JWT (có annotation konghq.comusername)
apiVersion v1
kind Secret
metadata
  name txu-jwt
  namespace backend
  labels
    konghq.comcredential true
    konghq.comcredential-type jwt
  annotations
    konghq.comusername txu-iss
type Opaque
stringData
  algorithm HS256
  key txu-iss
  secret txu-secret
---
# KongConsumer
apiVersion configuration.konghq.comv1
kind KongConsumer
metadata
  name txu-iss
  namespace backend
username txu-iss
credentials
  - txu-jwt
---
# KongPlugin kiểu JWT
apiVersion configuration.konghq.comv1
kind KongPlugin
metadata
  name jwt-auth
  namespace backend
config
  uri_param_names
    - jwt
  claims_to_verify
    - exp
plugin jwt
---
# Demo Ingress (áp dụng plugin)
apiVersion networking.k8s.iov1
kind Ingress
metadata
  name demo-api
  namespace backend
  annotations
    konghq.complugins jwt-auth
spec
  ingressClassName kong
  rules
    - http
        paths
          - path demo
            pathType Prefix
            backend
              service
                name hrm
                port
                  number 8080
